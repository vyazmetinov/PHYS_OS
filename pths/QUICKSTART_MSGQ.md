# Быстрый старт: pthread + Message Queue

## Что изменилось

Программа `itg.c` теперь использует **очереди сообщений System V** для передачи результатов от потоков:

- ✅ **Потоки (pthread)** - параллельные вычисления
- ✅ **Очереди сообщений** - безопасная передача результатов
- ✅ **Оба режима** - дискретный и непрерывный

## Быстрый запуск

```bash
cd /Users/ivan/CLionProjects/Phys_OS/pths

# Компиляция
gcc -o itg.out itg.c -lm -lpthread

# Запуск
./itg.out cont 0 4 0.01
```

## Запуск с тестами

```bash
# Автоматическое тестирование
./test_msgq.sh
```

## Примеры команд

```bash
# Непрерывная функция sqrt(x)
./itg.out cont 0 4 0.01      # [0, 4], eps=0.01
./itg.out cont 1 9 0.001     # [1, 9], eps=0.001
./itg.out cont 1 16 0.001    # [1, 16], eps=0.001

# Дискретные данные
./itg.out 5 0 1 2 3 4 0 1 1.414 1.732 2 1 5 0.01
```

## Что вы увидите

```
=== Режим непрерывной функции f(x) = sqrt(x) ===
Интервал: [0.000000, 4.000000], eps=0.010000

[Главный поток] Создана очередь сообщений (ID=131074)
[Главный поток] Запущено 3 потоков, ожидаю результаты...

[Поток 0] Отправлен результат: 1.016921 (отрезок [0.000000, 1.333333])
[Поток 1] Отправлен результат: 1.876511 (отрезок [1.333333, 2.666667])
[Поток 2] Отправлен результат: 2.430151 (отрезок [2.666667, 4.000000])

[Главный поток] Получен результат от потока 0: 1.016921
[Главный поток] Получен результат от потока 1: 1.876511
[Главный поток] Получен результат от потока 2: 2.430151
[Главный поток] Очередь сообщений удалена

=== РЕЗУЛЬТАТ (непрерывный) = 5.323582 ===
```

## Как работает

1. **Главный поток** создает очередь сообщений
2. Запускаются **3 pthread потока**
3. Каждый поток:
   - Вычисляет интеграл на своем отрезке
   - Отправляет результат через `msgsnd()`
4. **Главный поток**:
   - Получает результаты через `msgrcv()`
   - Суммирует их
   - Удаляет очередь

## Проверка очередей

```bash
# Посмотреть активные очереди
ipcs -q

# Очистить все очереди
ipcs -q | grep $(whoami) | awk '{print $2}' | xargs -I {} ipcrm -q {}
```

## Изменение количества потоков

Отредактируйте в `itg.c`:

```c
const int pthread_amnt = 3;  // Измените на нужное число
```

Затем пересоберите:

```bash
gcc -o itg.out itg.c -lm -lpthread
```

## Структура сообщения

```c
typedef struct {
    long mtype;        // Тип = 1
    int thread_id;     // ID потока
    double from_val;   // Начало
    double to_val;     // Конец
    double result;     // Результат
} msg_result_t;
```

## Файлы

- `itg.c` - основная программа (pthread + msgq)
- `itg_msgq.c` - версия с процессами (fork + msgq)
- `README_MSGQ.md` - подробная документация
- `test_msgq.sh` - скрипт тестирования
- `QUICKSTART_MSGQ.md` - этот файл

## Сравнение подходов

| Подход | Передача данных | Изоляция | Overhead |
|--------|----------------|----------|----------|
| **pthread** | Общая память | Низкая | Минимальный |
| **pthread + msgq** | Очередь | Средняя | Небольшой |
| **fork + msgq** | Очередь | Полная | Средний |

## Troubleshooting

### Ошибка: Operation not permitted

В некоторых окружениях (sandbox) доступ к IPC ограничен. Запустите напрямую из терминала:

```bash
cd /Users/ivan/CLionProjects/Phys_OS/pths
./itg.out cont 0 4 0.01
```

### Очередь не удаляется

Если программа аварийно завершилась:

```bash
# Посмотреть ID очередей
ipcs -q

# Удалить очередь
ipcrm -q <msgid>
```

### Результат = 0.000000

Проверьте:
1. Права на создание IPC объектов
2. Лимиты системы: `ipcs -l`
3. Запущен ли из правильной директории

## Дополнительная информация

Подробнее см. `README_MSGQ.md`

