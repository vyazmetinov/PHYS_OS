// Подключение заголовочных файлов
#include <stdio.h>       // Стандартный ввод-вывод (printf)
#include <unistd.h>      // POSIX API (sleep)
#include <signal.h>      // Работа с сигналами (здесь не используется)
#include <stdlib.h>      // Общие утилиты (atoi)
#include <zlib.h>        // Библиотека сжатия (здесь не используется)
#include <sys/ipc.h>     // IPC определения (здесь не используется)
#include <semaphore.h>   // POSIX семафоры (sem_t, sem_init, sem_wait, sem_post)
#include <pthread.h>     // POSIX потоки

// Семафор для матери-птицы (контролирует доступ к наполнению кормушки)
sem_t sem_mom;

// Семафор для птенцов (контролирует доступ к еде)
sem_t sem_child;


// Структура для передачи аргументов в потоки
typedef struct {
    int F;      // Количество порций еды в кормушке (Food)
    int id;     // Идентификатор птенца
} ThreadArgs;

// Глобальная переменная - счётчик оставшейся еды (serve)
int srv;

// Функция матери-птицы (выполняется в отдельном потоке)
void* mother(void* args) {
    sem_wait(&sem_mom);  // Ждём разрешения (уменьшаем семафор матери)
    
    // Мать наполняет кормушку
    printf("Кушайте гости дорогие на базаре все так дорого\n");
    
    ThreadArgs* arg = (ThreadArgs*)args;  // Преобразуем аргументы
    srv = arg->F;                          // Наполняем кормушку (восстанавливаем количество еды)
    
    sem_post(&sem_child);  // Разрешаем птенцам есть (увеличиваем семафор детей)
    
    sleep(2);  // Мать отдыхает 2 секунды
    
    return NULL;  // Завершаем поток
}

// Функция птенца (выполняется в отдельном потоке)
void* child(void* args) {
    sem_wait(&sem_child);  // Ждём доступа к еде (уменьшаем семафор детей)
    
    ThreadArgs* arg = (ThreadArgs*)args;  // Преобразуем аргументы
    
    // Птенец начинает есть
    printf("%d-й птенец приступает к еде\n", arg->id);
    
    srv--;  // Уменьшаем количество еды в кормушке
    
    // Птенец закончил есть
    printf("%d-й птенец поел\n", arg->id);
    
    sleep(2);  // Птенец отдыхает 2 секунды
    
    return NULL;  // Завершаем поток
}

// Главная функция программы
int main(int argc, char **argv) {
    int N = atoi(argv[1]);  // Количество птенцов (из первого аргумента)
    int F = atoi(argv[2]);  // Вместимость кормушки (из второго аргумента)
    
    // Инициализируем семафор матери со значением 1 (0 = локальный семафор для потоков)
    sem_init(&sem_mom, 0, 1);
    
    // Инициализируем семафор детей со значением F (количество доступных порций)
    sem_init(&sem_child, 0, F);
    
    pthread_t threads[N + 1];  // Массив потоков (N птенцов + 1 для матери)
    ThreadArgs arg;            // Структура для аргументов
    arg.F = F;                 // Устанавливаем вместимость кормушки
    srv = F;                   // Изначально кормушка полная
    
    // Цикл по всем птенцам
    for (int i = 1; i <= N; i++) {
        // Если еда закончилась, вызываем мать
        if (srv < 1) {
            // Создаём поток матери для наполнения кормушки
            pthread_create(&threads[0], NULL, mother, &arg);
            // Ждём, пока мать наполнит кормушку
            pthread_join(threads[0], NULL);
        }
        
        arg.id = i;  // Устанавливаем ID текущего птенца
        
        // Создаём поток для i-го птенца
        pthread_create(&threads[i], NULL, child, &arg);
        
        // Ждём, пока птенец поест (последовательное выполнение)
        pthread_join(threads[i], NULL);
    }
    
    // Уничтожаем семафоры (освобождаем ресурсы)
    sem_destroy(&sem_mom);
    sem_destroy(&sem_child);
}